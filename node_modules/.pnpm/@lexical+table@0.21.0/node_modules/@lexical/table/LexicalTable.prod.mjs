/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import{addClassNamesToElement as e,$findMatchingParent as t,removeClassNamesFromElement as n,objectKlassEquals as o,isHTMLElement as r}from"@lexical/utils";import{ElementNode as l,isHTMLElement as s,$createParagraphNode as i,$isElementNode as c,$isLineBreakNode as a,$isTextNode as u,$applyNodeReplacement as h,createCommand as d,$createTextNode as g,$getSelection as f,$isRangeSelection as m,$createPoint as p,$isParagraphNode as C,$normalizeSelection__EXPERIMENTAL as S,isCurrentlyReadOnlyMode as _,TEXT_TYPE_TO_FORMAT as w,$getNodeByKey as b,$getEditor as y,$setSelection as N,SELECTION_CHANGE_COMMAND as x,getDOMSelection as T,$createRangeSelection as v,$getRoot as R,COMMAND_PRIORITY_HIGH as O,KEY_ESCAPE_COMMAND as F,COMMAND_PRIORITY_CRITICAL as k,CUT_COMMAND as K,FORMAT_TEXT_COMMAND as E,FORMAT_ELEMENT_COMMAND as M,CONTROLLED_TEXT_INSERTION_COMMAND as A,KEY_TAB_COMMAND as $,FOCUS_COMMAND as W,SELECTION_INSERT_CLIPBOARD_NODES_COMMAND as H,$getPreviousSelection as P,$getNearestNodeFromDOMNode as B,$createRangeSelectionFromDom as L,INSERT_PARAGRAPH_COMMAND as D,$isRootOrShadowRoot as I,$isDecoratorNode as U,KEY_ARROW_DOWN_COMMAND as z,KEY_ARROW_UP_COMMAND as Y,KEY_ARROW_LEFT_COMMAND as q,KEY_ARROW_RIGHT_COMMAND as X,DELETE_WORD_COMMAND as J,DELETE_LINE_COMMAND as j,DELETE_CHARACTER_COMMAND as V,KEY_BACKSPACE_COMMAND as G,KEY_DELETE_COMMAND as Q,setDOMUnmanaged as Z}from"lexical";import{copyToClipboard as ee,$getClipboardDataFromSelection as te}from"@lexical/clipboard";const ne=/^(\d+(?:\.\d+)?)px$/,oe={BOTH:3,COLUMN:2,NO_STATUS:0,ROW:1};class re extends l{static getType(){return"tablecell"}static clone(e){return new re(e.__headerState,e.__colSpan,e.__width,e.__key)}afterCloneFrom(e){super.afterCloneFrom(e),this.__rowSpan=e.__rowSpan,this.__backgroundColor=e.__backgroundColor}static importDOM(){return{td:e=>({conversion:le,priority:0}),th:e=>({conversion:le,priority:0})}}static importJSON(e){const t=e.colSpan||1,n=e.rowSpan||1;return se(e.headerState,t,e.width||void 0).setRowSpan(n).setBackgroundColor(e.backgroundColor||null)}constructor(e=oe.NO_STATUS,t=1,n,o){super(o),this.__colSpan=t,this.__rowSpan=1,this.__headerState=e,this.__width=n,this.__backgroundColor=null}createDOM(t){const n=document.createElement(this.getTag());return this.__width&&(n.style.width=`${this.__width}px`),this.__colSpan>1&&(n.colSpan=this.__colSpan),this.__rowSpan>1&&(n.rowSpan=this.__rowSpan),null!==this.__backgroundColor&&(n.style.backgroundColor=this.__backgroundColor),e(n,t.theme.tableCell,this.hasHeader()&&t.theme.tableCellHeader),n}exportDOM(e){const t=super.exportDOM(e);if(t.element&&s(t.element)){const e=t.element;e.setAttribute("data-temporary-table-cell-lexical-key",this.getKey()),e.style.border="1px solid black",this.__colSpan>1&&(e.colSpan=this.__colSpan),this.__rowSpan>1&&(e.rowSpan=this.__rowSpan),e.style.width=`${this.getWidth()||75}px`,e.style.verticalAlign="top",e.style.textAlign="start",null===this.__backgroundColor&&this.hasHeader()&&(e.style.backgroundColor="#f2f3f5")}return t}exportJSON(){return{...super.exportJSON(),backgroundColor:this.getBackgroundColor(),colSpan:this.__colSpan,headerState:this.__headerState,rowSpan:this.__rowSpan,type:"tablecell",width:this.getWidth()}}getColSpan(){return this.getLatest().__colSpan}setColSpan(e){const t=this.getWritable();return t.__colSpan=e,t}getRowSpan(){return this.getLatest().__rowSpan}setRowSpan(e){const t=this.getWritable();return t.__rowSpan=e,t}getTag(){return this.hasHeader()?"th":"td"}setHeaderStyles(e,t=oe.BOTH){const n=this.getWritable();return n.__headerState=e&t|n.__headerState&~t,n}getHeaderStyles(){return this.getLatest().__headerState}setWidth(e){const t=this.getWritable();return t.__width=e,t}getWidth(){return this.getLatest().__width}getBackgroundColor(){return this.getLatest().__backgroundColor}setBackgroundColor(e){const t=this.getWritable();return t.__backgroundColor=e,t}toggleHeaderStyle(e){const t=this.getWritable();return(t.__headerState&e)===e?t.__headerState-=e:t.__headerState+=e,t}hasHeaderState(e){return(this.getHeaderStyles()&e)===e}hasHeader(){return this.getLatest().__headerState!==oe.NO_STATUS}updateDOM(e){return e.__headerState!==this.__headerState||e.__width!==this.__width||e.__colSpan!==this.__colSpan||e.__rowSpan!==this.__rowSpan||e.__backgroundColor!==this.__backgroundColor}isShadowRoot(){return!0}collapseAtStart(){return!0}canBeEmpty(){return!1}canIndent(){return!1}}function le(e){const t=e,n=e.nodeName.toLowerCase();let o;ne.test(t.style.width)&&(o=parseFloat(t.style.width));const r=se("th"===n?oe.ROW:oe.NO_STATUS,t.colSpan,o);r.__rowSpan=t.rowSpan;const l=t.style.backgroundColor;""!==l&&(r.__backgroundColor=l);const s=t.style,h=(s&&s.textDecoration||"").split(" "),d="700"===s.fontWeight||"bold"===s.fontWeight,g=h.includes("line-through"),f="italic"===s.fontStyle,m=h.includes("underline");return{after:e=>(0===e.length&&e.push(i()),e),forChild:(e,t)=>{if(ie(t)&&!c(e)){const t=i();return a(e)&&"\n"===e.getTextContent()?null:(u(e)&&(d&&e.toggleFormat("bold"),g&&e.toggleFormat("strikethrough"),f&&e.toggleFormat("italic"),m&&e.toggleFormat("underline")),t.append(e),t)}return e},node:r}}function se(e,t=1,n){return h(new re(e,t,n))}function ie(e){return e instanceof re}const ce=d("INSERT_TABLE_COMMAND");function ae(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ue=ae((function(e){const t=new URLSearchParams;t.append("code",e);for(let e=1;e<arguments.length;e++)t.append("v",arguments[e]);throw Error(`Minified Lexical error #${e}; visit https://lexical.dev/docs/error?${t} for the full message or use the non-minified dev environment for full errors and additional helpful warnings.`)}));const he="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement,de=he&&"documentMode"in document?document.documentMode:null,ge=he&&/^(?!.*Seamonkey)(?=.*Firefox).*/i.test(navigator.userAgent);he&&"InputEvent"in window&&!de&&new window.InputEvent("input");class fe extends l{static getType(){return"tablerow"}static clone(e){return new fe(e.__height,e.__key)}static importDOM(){return{tr:e=>({conversion:me,priority:0})}}static importJSON(e){return pe(e.height)}constructor(e,t){super(t),this.__height=e}exportJSON(){return{...super.exportJSON(),...this.getHeight()&&{height:this.getHeight()},type:"tablerow",version:1}}createDOM(t){const n=document.createElement("tr");return this.__height&&(n.style.height=`${this.__height}px`),e(n,t.theme.tableRow),n}extractWithChild(e,t,n){return"html"===n}isShadowRoot(){return!0}setHeight(e){return this.getWritable().__height=e,this.__height}getHeight(){return this.getLatest().__height}updateDOM(e){return e.__height!==this.__height}canBeEmpty(){return!1}canIndent(){return!1}}function me(e){const t=e;let n;return ne.test(t.style.height)&&(n=parseFloat(t.style.height)),{node:pe(n)}}function pe(e){return h(new fe(e))}function Ce(e){return e instanceof fe}function Se(e,t,n=!0){const o=At();for(let r=0;r<e;r++){const e=pe();for(let o=0;o<t;o++){let t=oe.NO_STATUS;"object"==typeof n?(0===r&&n.rows&&(t|=oe.ROW),0===o&&n.columns&&(t|=oe.COLUMN)):n&&(0===r&&(t|=oe.ROW),0===o&&(t|=oe.COLUMN));const l=se(t),s=i();s.append(g()),l.append(s),e.append(l)}o.append(e)}return o}function _e(e){const n=t(e,(e=>ie(e)));return ie(n)?n:null}function we(e){const n=t(e,(e=>Ce(e)));if(Ce(n))return n;throw new Error("Expected table cell to be inside of table row.")}function be(e){const n=t(e,(e=>$t(e)));if($t(n))return n;throw new Error("Expected table cell to be inside of table.")}function ye(e){const t=we(e);return be(t).getChildren().findIndex((e=>e.is(t)))}function Ne(e){return we(e).getChildren().findIndex((t=>t.is(e)))}function xe(e,t){const n=be(e),{x:o,y:r}=n.getCordsFromCellNode(e,t);return{above:n.getCellNodeFromCords(o,r-1,t),below:n.getCellNodeFromCords(o,r+1,t),left:n.getCellNodeFromCords(o-1,r,t),right:n.getCellNodeFromCords(o+1,r,t)}}function Te(e,t){const n=e.getChildren();if(t>=n.length||t<0)throw new Error("Expected table cell to be inside of table row.");return n[t].remove(),e}function ve(e,t,n=!0,o,r){const l=e.getChildren();if(t>=l.length||t<0)throw new Error("Table row target index out of range");const s=l[t];if(!Ce(s))throw new Error("Row before insertion index does not exist.");for(let e=0;e<o;e++){const e=s.getChildren(),t=e.length,o=pe();for(let n=0;n<t;n++){const t=e[n];ie(t)||ue(12);const{above:l,below:s}=xe(t,r);let c=oe.NO_STATUS;const a=l&&l.getWidth()||s&&s.getWidth()||void 0;(l&&l.hasHeaderState(oe.COLUMN)||s&&s.hasHeaderState(oe.COLUMN))&&(c|=oe.COLUMN);const u=se(c,1,a);u.append(i()),o.append(u)}n?s.insertAfter(o):s.insertBefore(o)}return e}const Re=(e,t)=>e===oe.BOTH||e===t?t:oe.NO_STATUS;function Oe(e=!0){const t=f();m(t)||ze(t)||ue(188);const n=t.focus.getNode(),[o,,r]=Be(n),[l,s]=He(r,o,o),c=l[0].length,{startRow:a}=s;let u=null;if(e){const e=a+o.__rowSpan-1,t=l[e],n=pe();for(let o=0;o<c;o++){const{cell:r,startRow:l}=t[o];if(l+r.__rowSpan-1<=e){const e=t[o].cell.__headerState,r=Re(e,oe.COLUMN);n.append(se(r).append(i()))}else r.setRowSpan(r.__rowSpan+1)}const s=r.getChildAtIndex(e);Ce(s)||ue(145),s.insertAfter(n),u=n}else{const e=l[a],t=pe();for(let n=0;n<c;n++){const{cell:o,startRow:r}=e[n];if(r===a){const o=e[n].cell.__headerState,r=Re(o,oe.COLUMN);t.append(se(r).append(i()))}else o.setRowSpan(o.__rowSpan+1)}const n=r.getChildAtIndex(a);Ce(n)||ue(145),n.insertBefore(t),u=t}return u}function Fe(e,t,n=!0,o,r){const l=e.getChildren(),s=[];for(let e=0;e<l.length;e++){const n=l[e];if(Ce(n))for(let e=0;e<o;e++){const e=n.getChildren();if(t>=e.length||t<0)throw new Error("Table column target index out of range");const o=e[t];ie(o)||ue(12);const{left:l,right:c}=xe(o,r);let a=oe.NO_STATUS;(l&&l.hasHeaderState(oe.ROW)||c&&c.hasHeaderState(oe.ROW))&&(a|=oe.ROW);const u=se(a);u.append(i()),s.push({newTableCell:u,targetCell:o})}}return s.forEach((({newTableCell:e,targetCell:t})=>{n?t.insertAfter(e):t.insertBefore(e)})),e}function ke(e=!0){const t=f();m(t)||ze(t)||ue(188);const n=t.anchor.getNode(),o=t.focus.getNode(),[r]=Be(n),[l,,s]=Be(o),[c,a,u]=He(s,l,r),h=c.length,d=e?Math.max(a.startColumn,u.startColumn):Math.min(a.startColumn,u.startColumn),g=e?d+l.__colSpan-1:d-1,p=s.getFirstChild();Ce(p)||ue(120);let C=null;function S(e=oe.NO_STATUS){const t=se(e).append(i());return null===C&&(C=t),t}let _=p;e:for(let e=0;e<h;e++){if(0!==e){const e=_.getNextSibling();Ce(e)||ue(121),_=e}const t=c[e],n=t[g<0?0:g].cell.__headerState,o=Re(n,oe.ROW);if(g<0){$e(_,S(o));continue}const{cell:r,startColumn:l,startRow:s}=t[g];if(l+r.__colSpan-1<=g){let n=r,l=s,i=g;for(;l!==e&&n.__rowSpan>1;){if(i-=r.__colSpan,!(i>=0)){_.append(S(o));continue e}{const{cell:e,startRow:o}=t[i];n=e,l=o}}n.insertAfter(S(o))}else r.setColSpan(r.__colSpan+1)}null!==C&&Ae(C);const w=s.getColWidths();if(w){const e=[...w],t=g<0?0:g,n=e[t];e.splice(t,0,n),s.setColWidths(e)}return C}function Ke(e,t){const n=e.getChildren();for(let e=0;e<n.length;e++){const o=n[e];if(Ce(o)){const e=o.getChildren();if(t>=e.length||t<0)throw new Error("Table column target index out of range");e[t].remove()}}return e}function Ee(){const e=f();m(e)||ze(e)||ue(188);const[t,n]=e.isBackward()?[e.focus.getNode(),e.anchor.getNode()]:[e.anchor.getNode(),e.focus.getNode()],[o,,r]=Be(t),[l]=Be(n),[s,i,c]=He(r,o,l),{startRow:a}=i,{startRow:u}=c,h=u+l.__rowSpan-1;if(s.length===h-a+1)return void r.remove();const d=s[0].length,g=s[h+1],p=r.getChildAtIndex(h+1);for(let e=h;e>=a;e--){for(let t=d-1;t>=0;t--){const{cell:n,startRow:o,startColumn:r}=s[e][t];if(r===t&&(e===a&&o<a&&n.setRowSpan(n.__rowSpan-(o-a)),o>=a&&o+n.__rowSpan-1>h))if(n.setRowSpan(n.__rowSpan-(h-o+1)),null===p&&ue(122),0===t)$e(p,n);else{const{cell:e}=g[t-1];e.insertAfter(n)}}const t=r.getChildAtIndex(e);Ce(t)||ue(206,String(e)),t.remove()}if(void 0!==g){const{cell:e}=g[0];Ae(e)}else{const e=s[a-1],{cell:t}=e[0];Ae(t)}}function Me(){const e=f();m(e)||ze(e)||ue(188);const t=e.anchor.getNode(),n=e.focus.getNode(),[o,,r]=Be(t),[l]=Be(n),[s,i,c]=He(r,o,l),{startColumn:a}=i,{startRow:u,startColumn:h}=c,d=Math.min(a,h),g=Math.max(a+o.__colSpan-1,h+l.__colSpan-1),p=g-d+1;if(s[0].length===g-d+1)return r.selectPrevious(),void r.remove();const C=s.length;for(let e=0;e<C;e++)for(let t=d;t<=g;t++){const{cell:n,startColumn:o}=s[e][t];if(o<d){if(t===d){const e=d-o;n.setColSpan(n.__colSpan-Math.min(p,n.__colSpan-e))}}else if(o+n.__colSpan-1>g){if(t===g){const e=g-o+1;n.setColSpan(n.__colSpan-e)}}else n.remove()}const S=s[u],_=a>h?S[a+o.__colSpan]:S[h+l.__colSpan];if(void 0!==_){const{cell:e}=_;Ae(e)}else{const e=h<a?S[h-1]:S[a-1],{cell:t}=e;Ae(t)}const w=r.getColWidths();if(w){const e=[...w];e.splice(d,p),r.setColWidths(e)}}function Ae(e){const t=e.getFirstDescendant();null==t?e.selectStart():t.getParentOrThrow().selectStart()}function $e(e,t){const n=e.getFirstChild();null!==n?n.insertBefore(t):e.append(t)}function We(){const e=f();m(e)||ze(e)||ue(188);const t=e.anchor.getNode(),[n,o,r]=Be(t),l=n.__colSpan,s=n.__rowSpan;if(1===l&&1===s)return;const[c,a]=He(r,n,n),{startColumn:u,startRow:h}=a,d=n.__headerState&oe.COLUMN,g=Array.from({length:l},((e,t)=>{let n=d;for(let e=0;0!==n&&e<c.length;e++)n&=c[e][t+u].cell.__headerState;return n})),p=n.__headerState&oe.ROW,C=Array.from({length:s},((e,t)=>{let n=p;for(let e=0;0!==n&&e<c[0].length;e++)n&=c[t+h][e].cell.__headerState;return n}));if(l>1){for(let e=1;e<l;e++)n.insertAfter(se(g[e]|C[0]).append(i()));n.setColSpan(1)}if(s>1){let e;for(let t=1;t<s;t++){const n=h+t,r=c[n];e=(e||o).getNextSibling(),Ce(e)||ue(125);let s=null;for(let e=0;e<u;e++){const t=r[e],o=t.cell;t.startRow===n&&(s=o),o.__colSpan>1&&(e+=o.__colSpan-1)}if(null===s)for(let n=l-1;n>=0;n--)$e(e,se(g[n]|C[t]).append(i()));else for(let e=l-1;e>=0;e--)s.insertAfter(se(g[e]|C[t]).append(i()))}n.setRowSpan(1)}}function He(e,t,n){const[o,r,l]=Pe(e,t,n);return null===r&&ue(207),null===l&&ue(208),[o,r,l]}function Pe(e,t,n){const o=[];let r=null,l=null;function s(e){let t=o[e];return void 0===t&&(o[e]=t=[]),t}const i=e.getChildren();for(let e=0;e<i.length;e++){const o=i[e];Ce(o)||ue(209);for(let c=o.getFirstChild(),a=0;null!=c;c=c.getNextSibling()){ie(c)||ue(147);const o=s(e);for(;void 0!==o[a];)a++;const u={cell:c,startColumn:a,startRow:e},{__rowSpan:h,__colSpan:d}=c;for(let t=0;t<h&&!(e+t>=i.length);t++){const n=s(e+t);for(let e=0;e<d;e++)n[a+e]=u}null!==t&&null===r&&t.is(c)&&(r=u),null!==n&&null===l&&n.is(c)&&(l=u)}}return[o,r,l]}function Be(e){let n;if(e instanceof re)n=e;else if("__type"in e){const o=t(e,ie);ie(o)||ue(148),n=o}else{const o=t(e.getNode(),ie);ie(o)||ue(148),n=o}const o=n.getParent();Ce(o)||ue(149);const r=o.getParent();return $t(r)||ue(210),[n,o,r]}function Le(e,t,n){let o=Math.min(t.startColumn,n.startColumn),r=Math.min(t.startRow,n.startRow),l=Math.max(t.startColumn+t.cell.__colSpan-1,n.startColumn+n.cell.__colSpan-1),s=Math.max(t.startRow+t.cell.__rowSpan-1,n.startRow+n.cell.__rowSpan-1),i=o,c=r,a=o,u=r;function h(e){const{cell:t,startColumn:n,startRow:i}=e;o=Math.min(o,n),r=Math.min(r,i),l=Math.max(l,n+t.__colSpan-1),s=Math.max(s,i+t.__rowSpan-1)}for(;o<i||r<c||l>a||s>u;){if(o<i){const t=u-c,n=i-1;for(let o=0;o<=t;o++)h(e[c+o][n]);i=n}if(r<c){const t=a-i,n=c-1;for(let o=0;o<=t;o++)h(e[n][i+o]);c=n}if(l>a){const t=u-c,n=a+1;for(let o=0;o<=t;o++)h(e[c+o][n]);a=n}if(s>u){const t=a-i,n=u+1;for(let o=0;o<=t;o++)h(e[n][i+o]);u=n}}return{maxColumn:l,maxRow:s,minColumn:o,minRow:r}}function De(e){const[t,,n]=Be(e),o=n.getChildren(),r=o.length,l=o[0].getChildren().length,s=new Array(r);for(let e=0;e<r;e++)s[e]=new Array(l);for(let e=0;e<r;e++){const n=o[e].getChildren();let r=0;for(let o=0;o<n.length;o++){for(;s[e][r];)r++;const l=n[o],i=l.__rowSpan||1,c=l.__colSpan||1;for(let t=0;t<i;t++)for(let n=0;n<c;n++)s[e+t][r+n]=l;if(t===l)return{colSpan:c,columnIndex:r,rowIndex:e,rowSpan:i};r+=c}}return null}function Ie(e){const[[n,o,r,l],[s,i,c,a]]=["anchor","focus"].map((n=>{const o=e[n].getNode(),r=t(o,ie);ie(r)||ue(238,n,o.getKey(),o.getType());const l=r.getParent();Ce(l)||ue(239,n);const s=l.getParent();return $t(s)||ue(240,n),[o,r,l,s]}));return l.is(a)||ue(241),{anchorCell:o,anchorNode:n,anchorRow:r,anchorTable:l,focusCell:i,focusNode:s,focusRow:c,focusTable:a}}class Ue{constructor(e,t,n){this.anchor=t,this.focus=n,t._selection=this,n._selection=this,this._cachedNodes=null,this.dirty=!1,this.tableKey=e}getStartEndPoints(){return[this.anchor,this.focus]}isValid(){return"root"!==this.tableKey&&"root"!==this.anchor.key&&"element"===this.anchor.type&&"root"!==this.focus.key&&"element"===this.focus.type}isBackward(){return this.focus.isBefore(this.anchor)}getCachedNodes(){return this._cachedNodes}setCachedNodes(e){this._cachedNodes=e}is(e){return ze(e)&&this.tableKey===e.tableKey&&this.anchor.is(e.anchor)&&this.focus.is(e.focus)}set(e,t,n){this.dirty=this.dirty||e!==this.tableKey||t!==this.anchor.key||n!==this.focus.key,this.tableKey=e,this.anchor.key=t,this.focus.key=n,this._cachedNodes=null}clone(){return new Ue(this.tableKey,p(this.anchor.key,this.anchor.offset,this.anchor.type),p(this.focus.key,this.focus.offset,this.focus.type))}isCollapsed(){return!1}extract(){return this.getNodes()}insertRawText(e){}insertText(){}hasFormat(e){let t=0;this.getNodes().filter(ie).forEach((e=>{const n=e.getFirstChild();C(n)&&(t|=n.getTextFormat())}));const n=w[e];return!!(t&n)}insertNodes(e){const t=this.focus.getNode();c(t)||ue(151);S(t.select(0,t.getChildrenSize())).insertNodes(e)}getShape(){const{anchorCell:e,focusCell:t}=Ie(this),n=De(e);null===n&&ue(153);const o=De(t);null===o&&ue(155);const r=Math.min(n.columnIndex,o.columnIndex),l=Math.max(n.columnIndex+n.colSpan-1,o.columnIndex+o.colSpan-1),s=Math.min(n.rowIndex,o.rowIndex),i=Math.max(n.rowIndex+n.rowSpan-1,o.rowIndex+o.rowSpan-1);return{fromX:Math.min(r,l),fromY:Math.min(s,i),toX:Math.max(r,l),toY:Math.max(s,i)}}getNodes(){if(!this.isValid())return[];const e=this._cachedNodes;if(null!==e)return e;const{anchorTable:t,anchorCell:n,focusCell:o}=Ie(this),r=o.getParents()[1];if(r!==t){if(t.isParentOf(o)){const e=r.getParent();null==e&&ue(159),this.set(this.tableKey,o.getKey(),e.getKey())}else{const e=t.getParent();null==e&&ue(158),this.set(this.tableKey,e.getKey(),o.getKey())}return this.getNodes()}const[l,s,i]=He(t,n,o),{minColumn:c,maxColumn:a,minRow:u,maxRow:h}=Le(l,s,i),d=new Map([[t.getKey(),t]]);let g=null;for(let e=u;e<=h;e++)for(let t=c;t<=a;t++){const{cell:n}=l[e][t],o=n.getParent();Ce(o)||ue(160),o!==g&&(d.set(o.getKey(),o),g=o),d.has(n.getKey())||qe(n,(e=>{d.set(e.getKey(),e)}))}const f=Array.from(d.values());return _()||(this._cachedNodes=f),f}getTextContent(){const e=this.getNodes().filter((e=>ie(e)));let t="";for(let n=0;n<e.length;n++){const o=e[n],r=o.__parent,l=(e[n+1]||{}).__parent;t+=o.getTextContent()+(l!==r?"\n":"\t")}return t}}function ze(e){return e instanceof Ue}function Ye(){const e=p("root",0,"element"),t=p("root",0,"element");return new Ue("root",e,t)}function qe(e,t){const n=[[e]];for(let e=n.at(-1);void 0!==e&&n.length>0;e=n.at(-1)){const o=e.pop();void 0===o?n.pop():!1!==t(o)&&c(o)&&n.push(o.getChildren())}}function Xe(e,t=y()){const n=b(e);$t(n)||ue(231,e);const o=Ve(n,t.getElementByKey(e));return null===o&&ue(232,e),{tableElement:o,tableNode:n}}class Je{constructor(e,t){this.isHighlightingCells=!1,this.anchorX=-1,this.anchorY=-1,this.focusX=-1,this.focusY=-1,this.listenersToRemove=new Set,this.tableNodeKey=t,this.editor=e,this.table={columns:0,domRows:[],rows:0},this.tableSelection=null,this.anchorCellNodeKey=null,this.focusCellNodeKey=null,this.anchorCell=null,this.focusCell=null,this.hasHijackedSelectionStyles=!1,this.isSelecting=!1,this.shouldCheckSelection=!1,this.abortController=new AbortController,this.listenerOptions={signal:this.abortController.signal},this.nextFocus=null,this.trackTable()}getTable(){return this.table}removeListeners(){this.abortController.abort("removeListeners"),Array.from(this.listenersToRemove).forEach((e=>e())),this.listenersToRemove.clear()}$lookup(){return Xe(this.tableNodeKey,this.editor)}trackTable(){const e=new MutationObserver((e=>{this.editor.getEditorState().read((()=>{let t=!1;for(let n=0;n<e.length;n++){const o=e[n].target.nodeName;if("TABLE"===o||"TBODY"===o||"THEAD"===o||"TR"===o){t=!0;break}}if(!t)return;const{tableNode:n,tableElement:o}=this.$lookup();this.table=lt(n,o)}),{editor:this.editor})}));this.editor.getEditorState().read((()=>{const{tableNode:t,tableElement:n}=this.$lookup();this.table=lt(t,n),e.observe(n,{attributes:!0,childList:!0,subtree:!0})}),{editor:this.editor})}$clearHighlight(){const e=this.editor;this.isHighlightingCells=!1,this.anchorX=-1,this.anchorY=-1,this.focusX=-1,this.focusY=-1,this.tableSelection=null,this.anchorCellNodeKey=null,this.focusCellNodeKey=null,this.anchorCell=null,this.focusCell=null,this.hasHijackedSelectionStyles=!1,this.$enableHighlightStyle();const{tableNode:t,tableElement:n}=this.$lookup();st(e,lt(t,n),null),null!==f()&&(N(null),e.dispatchCommand(x,void 0))}$enableHighlightStyle(){const e=this.editor,{tableElement:t}=this.$lookup();n(t,e._config.theme.tableSelection),t.classList.remove("disable-selection"),this.hasHijackedSelectionStyles=!1}$disableHighlightStyle(){const{tableElement:t}=this.$lookup();e(t,this.editor._config.theme.tableSelection),this.hasHijackedSelectionStyles=!0}$updateTableTableSelection(e){if(null!==e){e.tableKey!==this.tableNodeKey&&ue(233,e.tableKey,this.tableNodeKey);const t=this.editor;this.tableSelection=e,this.isHighlightingCells=!0,this.$disableHighlightStyle(),this.updateDOMSelection(),st(t,this.table,this.tableSelection)}else this.$clearHighlight()}setShouldCheckSelection(){this.shouldCheckSelection=!0}getAndClearShouldCheckSelection(){return!!this.shouldCheckSelection&&(this.shouldCheckSelection=!1,!0)}setNextFocus(e){this.nextFocus=e}getAndClearNextFocus(){const{nextFocus:e}=this;return null!==e&&(this.nextFocus=null),e}updateDOMSelection(){if(null!==this.anchorCell&&null!==this.focusCell){const e=T(this.editor._window);e&&e.rangeCount>0&&e.removeAllRanges()}}$setFocusCellForSelection(e,t=!1){const n=this.editor,{tableNode:o}=this.$lookup(),r=e.x,l=e.y;if(this.focusCell=e,this.isHighlightingCells||this.anchorX===r&&this.anchorY===l&&!t){if(r===this.focusX&&l===this.focusY)return!1}else this.isHighlightingCells=!0,this.$disableHighlightStyle();if(this.focusX=r,this.focusY=l,this.isHighlightingCells){const t=Tt(o,e.elem);if(null!=this.tableSelection&&null!=this.anchorCellNodeKey&&null!==t)return this.focusCellNodeKey=t.getKey(),this.tableSelection=function(e,t,n){e.getKey(),t.getKey(),n.getKey();const o=f(),r=ze(o)?o.clone():Ye();return r.set(e.getKey(),t.getKey(),n.getKey()),r}(o,this.$getAnchorTableCellOrThrow(),t),N(this.tableSelection),n.dispatchCommand(x,void 0),st(n,this.table,this.tableSelection),!0}return!1}$getAnchorTableCell(){return this.anchorCellNodeKey?b(this.anchorCellNodeKey):null}$getAnchorTableCellOrThrow(){const e=this.$getAnchorTableCell();return null===e&&ue(234),e}$getFocusTableCell(){return this.focusCellNodeKey?b(this.focusCellNodeKey):null}$getFocusTableCellOrThrow(){const e=this.$getFocusTableCell();return null===e&&ue(235),e}$setAnchorCellForSelection(e){this.isHighlightingCells=!1,this.anchorCell=e,this.anchorX=e.x,this.anchorY=e.y;const{tableNode:t}=this.$lookup(),n=Tt(t,e.elem);if(null!==n){const e=n.getKey();this.tableSelection=null!=this.tableSelection?this.tableSelection.clone():Ye(),this.anchorCellNodeKey=e}}$formatCells(e){const t=f();ze(t)||ue(236);const n=v(),o=n.anchor,r=n.focus,l=t.getNodes().filter(ie);l.length>0||ue(237);const s=l[0].getFirstChild(),i=C(s)?s.getFormatFlags(e,null):null;l.forEach((t=>{o.set(t.getKey(),0,"element"),r.set(t.getKey(),t.getChildrenSize(),"element"),n.formatText(e,i)})),N(t),this.editor.dispatchCommand(x,void 0)}$clearText(){const{editor:e}=this,t=b(this.tableNodeKey);if(!$t(t))throw new Error("Expected TableNode.");const n=f();ze(n)||ue(11);const o=n.getNodes().filter(ie);if(o.length!==this.table.columns*this.table.rows)o.forEach((e=>{if(c(e)){const t=i(),n=g();t.append(n),e.append(t),e.getChildren().forEach((e=>{e!==t&&e.remove()}))}})),st(e,this.table,null),N(null),e.dispatchCommand(x,void 0);else{t.selectPrevious(),t.remove();R().selectStart()}}}const je="__lexicalTableSelection";function Ve(e,t){if(!t)return t;const n="TABLE"===t.nodeName?t:e.getDOMSlot(t).element;return"TABLE"!==n.nodeName&&ue(245,t.nodeName),n}function Ge(e){return e._window}function Qe(e,t){for(let n=t,o=null;null!==n;n=n.getParent()){if(e.is(n))return o;ie(n)&&(o=n)}return null}const Ze=[[z,"down"],[Y,"up"],[q,"backward"],[X,"forward"]],et=[J,j,V],tt=[G,Q];function nt(e,n,r,l){const s=r.getRootElement(),a=Ge(r);null!==s&&null!==a||ue(246);const h=new Je(r,e.getKey()),d=Ve(e,n);!function(e,t){null!==ot(e)&&ue(205);e[je]=t}(d,h),h.listenersToRemove.add((()=>function(e,t){ot(e)===t&&delete e[je]}(d,h)));d.addEventListener("mousedown",(t=>{if(0!==t.button)return;if(!a)return;const n=rt(t.target);null!==n&&r.update((()=>{const o=P();if(ge&&t.shiftKey&&ft(o,e)&&(m(o)||ze(o))){const r=o.anchor.getNode(),l=Qe(e,o.anchor.getNode());if(l)h.$setAnchorCellForSelection(xt(h,l)),h.$setFocusCellForSelection(n),bt(t);else{(e.isBefore(r)?e.selectStart():e.selectEnd()).anchor.set(o.anchor.key,o.anchor.offset,o.anchor.type)}}else h.$setAnchorCellForSelection(n)})),(()=>{if(h.isSelecting)return;const e=()=>{h.isSelecting=!1,a.removeEventListener("mouseup",e),a.removeEventListener("mousemove",t)},t=n=>{if(1&~n.buttons&&h.isSelecting)return h.isSelecting=!1,a.removeEventListener("mouseup",e),void a.removeEventListener("mousemove",t);const o=!d.contains(n.target);let l=null;if(o){for(const e of document.elementsFromPoint(n.clientX,n.clientY))if(l=d.contains(e)?rt(e):null,l)break}else l=rt(n.target);!l||null!==h.focusCell&&l.elem===h.focusCell.elem||(h.setNextFocus({focusCell:l,override:o}),r.dispatchCommand(x,void 0))};h.isSelecting=!0,a.addEventListener("mouseup",e,h.listenerOptions),a.addEventListener("mousemove",t,h.listenerOptions)})()}),h.listenerOptions);a.addEventListener("mousedown",(e=>{0===e.button&&r.update((()=>{const t=f(),n=e.target;ze(t)&&t.tableKey===h.tableNodeKey&&s.contains(n)&&h.$clearHighlight()}))}),h.listenerOptions);for(const[t,n]of Ze)h.listenersToRemove.add(r.registerCommand(t,(t=>wt(r,t,n,e,h)),O));h.listenersToRemove.add(r.registerCommand(F,(t=>{const n=f();if(ze(n)){const o=Qe(e,n.focus.getNode());if(null!==o)return bt(t),o.selectEnd(),!0}return!1}),O));const p=n=>()=>{const o=f();if(!ft(o,e))return!1;if(ze(o))return h.$clearText(),!0;if(m(o)){if(!ie(Qe(e,o.anchor.getNode())))return!1;const r=o.anchor.getNode(),l=o.focus.getNode(),s=e.isParentOf(r),i=e.isParentOf(l);if(s&&!i||i&&!s)return h.$clearText(),!0;const a=t(o.anchor.getNode(),(e=>c(e))),u=a&&t(a,(e=>c(e)&&ie(e.getParent())));if(!c(u)||!c(a))return!1;if(n===j&&null===u.getPreviousSibling())return!0}return!1};for(const e of et)h.listenersToRemove.add(r.registerCommand(e,p(e),k));const C=t=>{const n=f();if(!ze(n)&&!m(n))return!1;const o=e.isParentOf(n.anchor.getNode());if(o!==e.isParentOf(n.focus.getNode())){const t=o?"anchor":"focus",r=o?"focus":"anchor",{key:l,offset:s,type:i}=n[r];return e[n[t].isBefore(n[r])?"selectPrevious":"selectNext"]()[r].set(l,s,i),!1}return!!ze(n)&&(t&&(t.preventDefault(),t.stopPropagation()),h.$clearText(),!0)};for(const e of tt)h.listenersToRemove.add(r.registerCommand(e,C,k));return h.listenersToRemove.add(r.registerCommand(K,(e=>{const t=f();if(t){if(!ze(t)&&!m(t))return!1;ee(r,o(e,ClipboardEvent)?e:null,te(t));const n=C(e);return m(t)?(t.removeText(),!0):n}return!1}),k)),h.listenersToRemove.add(r.registerCommand(E,(n=>{const o=f();if(!ft(o,e))return!1;if(ze(o))return h.$formatCells(n),!0;if(m(o)){const e=t(o.anchor.getNode(),(e=>ie(e)));if(!ie(e))return!1}return!1}),k)),h.listenersToRemove.add(r.registerCommand(M,(t=>{const n=f();if(!ze(n)||!ft(n,e))return!1;const o=n.anchor.getNode(),r=n.focus.getNode();if(!ie(o)||!ie(r))return!1;const[l,s,i]=He(e,o,r),a=Math.max(s.startRow+s.cell.__rowSpan-1,i.startRow+i.cell.__rowSpan-1),u=Math.max(s.startColumn+s.cell.__colSpan-1,i.startColumn+i.cell.__colSpan-1),h=Math.min(s.startRow,i.startRow),d=Math.min(s.startColumn,i.startColumn),g=new Set;for(let e=h;e<=a;e++)for(let n=d;n<=u;n++){const o=l[e][n].cell;if(g.has(o))continue;g.add(o),o.setFormat(t);const r=o.getChildren();for(let e=0;e<r.length;e++){const n=r[e];c(n)&&!n.isInline()&&n.setFormat(t)}}return!0}),k)),h.listenersToRemove.add(r.registerCommand(A,(n=>{const o=f();if(!ft(o,e))return!1;if(ze(o))return h.$clearHighlight(),!1;if(m(o)){const l=t(o.anchor.getNode(),(e=>ie(e)));if(!ie(l))return!1;if("string"==typeof n){const t=Nt(r,o,e);if(t)return yt(t,e,[g(n)]),!0}}return!1}),k)),l&&h.listenersToRemove.add(r.registerCommand($,(n=>{const o=f();if(!m(o)||!o.isCollapsed()||!ft(o,e))return!1;const r=St(o.anchor.getNode());return!(null===r||!e.is(_t(r)))&&(bt(n),function(e,n){const o="next"===n?"getNextSibling":"getPreviousSibling",r="next"===n?"getFirstChild":"getLastChild",l=e[o]();if(c(l))return l.selectEnd();const s=t(e,Ce);null===s&&ue(247);for(let e=s[o]();Ce(e);e=e[o]()){const t=e[r]();if(c(t))return t.selectEnd()}const i=t(s,$t);null===i&&ue(248);"next"===n?i.selectNext():i.selectPrevious()}(r,n.shiftKey?"previous":"next"),!0)}),k)),h.listenersToRemove.add(r.registerCommand(W,(t=>e.isSelected()),O)),h.listenersToRemove.add(r.registerCommand(H,(e=>{const{nodes:n,selection:o}=e,r=o.getStartEndPoints(),l=ze(o),s=m(o)&&null!==t(o.anchor.getNode(),(e=>ie(e)))&&null!==t(o.focus.getNode(),(e=>ie(e)))||l;if(1!==n.length||!$t(n[0])||!s||null===r)return!1;const[c]=r,a=n[0],h=a.getChildren(),d=a.getFirstChildOrThrow().getChildrenSize(),g=a.getChildrenSize(),f=t(c.getNode(),(e=>ie(e))),p=f&&t(f,(e=>Ce(e))),C=p&&t(p,(e=>$t(e)));if(!ie(f)||!Ce(p)||!$t(C))return!1;const S=p.getIndexWithinParent(),_=Math.min(C.getChildrenSize()-1,S+g-1),w=f.getIndexWithinParent(),b=Math.min(p.getChildrenSize()-1,w+d-1),y=Math.min(w,b),N=Math.min(S,_),x=Math.max(w,b),T=Math.max(S,_),v=C.getChildren();let R=0;for(let e=N;e<=T;e++){const t=v[e];if(!Ce(t))return!1;const n=h[R];if(!Ce(n))return!1;const o=t.getChildren(),r=n.getChildren();let l=0;for(let e=y;e<=x;e++){const t=o[e];if(!ie(t))return!1;const n=r[l];if(!ie(n))return!1;const s=t.getChildren();n.getChildren().forEach((e=>{if(u(e)){i().append(e),t.append(e)}else t.append(e)})),s.forEach((e=>e.remove())),l++}R++}return!0}),k)),h.listenersToRemove.add(r.registerCommand(x,(()=>{const n=f(),o=P(),l=h.getAndClearNextFocus();if(null!==l){const{focusCell:t}=l;if(ze(n)&&n.tableKey===h.tableNodeKey)return(t.x!==h.focusX||t.y!==h.focusY)&&(h.$setFocusCellForSelection(t),!0);if(t!==h.anchorCell&&ft(n,e))return h.$setFocusCellForSelection(t),!0}if(h.getAndClearShouldCheckSelection()&&m(o)&&m(n)&&n.isCollapsed()){const o=n.anchor.getNode(),r=e.getFirstChild(),l=St(o);if(null!==l&&Ce(r)){const n=r.getFirstChild();if(ie(n)&&e.is(t(l,(t=>t.is(e)||t.is(n)))))return n.selectStart(),!0}}if(m(n)){const{anchor:t,focus:o}=n,l=t.getNode(),s=o.getNode(),i=St(l),c=St(s),a=!(!i||!e.is(_t(i))),u=!(!c||!e.is(_t(c))),d=a!==u,g=a&&u,f=n.isBackward();if(d){const t=n.clone();if(u){const[n]=He(e,c,c),o=n[0][0].cell,r=n[n.length-1].at(-1).cell;t.focus.set(f?o.getKey():r.getKey(),f?o.getChildrenSize():r.getChildrenSize(),"element")}else if(a){const[n]=He(e,i,i),o=n[0][0].cell,r=n[n.length-1].at(-1).cell;t.anchor.set(f?r.getKey():o.getKey(),f?r.getChildrenSize():0,"element")}N(t),ct(r,h)}else g&&(i.is(c)||(h.$setAnchorCellForSelection(xt(h,i)),h.$setFocusCellForSelection(xt(h,c),!0)))}else if(n&&ze(n)&&n.is(o)&&n.tableKey===e.getKey()){const t=T(a);if(t&&t.anchorNode&&t.focusNode){const o=B(t.focusNode),l=o&&!e.isParentOf(o),s=B(t.anchorNode),i=s&&e.isParentOf(s);if(l&&i&&t.rangeCount>0){const o=L(t,r);o&&(o.anchor.set(e.getKey(),n.isBackward()?e.getChildrenSize():0,"element"),t.removeAllRanges(),N(o))}}}return n&&!n.is(o)&&(ze(n)||ze(o))&&h.tableSelection&&!h.tableSelection.is(o)?(ze(n)&&n.tableKey===h.tableNodeKey?h.$updateTableTableSelection(n):!ze(n)&&ze(o)&&o.tableKey===h.tableNodeKey&&h.$updateTableTableSelection(null),!1):(h.hasHijackedSelectionStyles&&!e.isSelected()?function(e,t){t.$enableHighlightStyle(),it(t.table,(t=>{const n=t.elem;t.highlighted=!1,Ct(e,t),n.getAttribute("style")||n.removeAttribute("style")}))}(r,h):!h.hasHijackedSelectionStyles&&e.isSelected()&&ct(r,h),!1)}),k)),h.listenersToRemove.add(r.registerCommand(D,(()=>{const t=f();if(!m(t)||!t.isCollapsed()||!ft(t,e))return!1;const n=Nt(r,t,e);return!!n&&(yt(n,e),!0)}),k)),h}function ot(e){return e[je]||null}function rt(e){let t=e;for(;null!=t;){const e=t.nodeName;if("TD"===e||"TH"===e){const e=t._cell;return void 0===e?null:e}t=t.parentNode}return null}function lt(e,t){const n=[],o={columns:0,domRows:n,rows:0};let r=Ve(e,t).querySelector("tr"),l=0,s=0;for(n.length=0;null!=r;){const e=r.nodeName;if("TD"===e||"TH"===e){const e={elem:r,hasBackgroundColor:""!==r.style.backgroundColor,highlighted:!1,x:l,y:s};r._cell=e;let t=n[s];void 0===t&&(t=n[s]=[]),t[l]=e}else{const e=r.firstChild;if(null!=e){r=e;continue}}const t=r.nextSibling;if(null!=t){l++,r=t;continue}const o=r.parentNode;if(null!=o){const e=o.nextSibling;if(null==e)break;s++,l=0,r=e}}return o.columns=l+1,o.rows=s+1,o}function st(e,t,n){const o=new Set(n?n.getNodes():[]);it(t,((t,n)=>{const r=t.elem;o.has(n)?(t.highlighted=!0,pt(e,t)):(t.highlighted=!1,Ct(e,t),r.getAttribute("style")||r.removeAttribute("style"))}))}function it(e,t){const{domRows:n}=e;for(let e=0;e<n.length;e++){const o=n[e];if(o)for(let n=0;n<o.length;n++){const r=o[n];if(!r)continue;const l=B(r.elem);null!==l&&t(r,l,{x:n,y:e})}}}function ct(e,t){t.$disableHighlightStyle(),it(t.table,(t=>{t.highlighted=!0,pt(e,t)}))}const at=(e,t,n,o,r)=>{const l="forward"===r;switch(r){case"backward":case"forward":return n!==(l?e.table.columns-1:0)?mt(t.getCellNodeFromCordsOrThrow(n+(l?1:-1),o,e.table),l):o!==(l?e.table.rows-1:0)?mt(t.getCellNodeFromCordsOrThrow(l?0:e.table.columns-1,o+(l?1:-1),e.table),l):l?t.selectNext():t.selectPrevious(),!0;case"up":return 0!==o?mt(t.getCellNodeFromCordsOrThrow(n,o-1,e.table),!1):t.selectPrevious(),!0;case"down":return o!==e.table.rows-1?mt(t.getCellNodeFromCordsOrThrow(n,o+1,e.table),!0):t.selectNext(),!0;default:return!1}};function ut(e,t){let n,o;if(t.startColumn===e.minColumn)n="minColumn";else{if(t.startColumn+t.cell.__colSpan-1!==e.maxColumn)return null;n="maxColumn"}if(t.startRow===e.minRow)o="minRow";else{if(t.startRow+t.cell.__rowSpan-1!==e.maxRow)return null;o="maxRow"}return[n,o]}function ht([e,t]){return["minColumn"===e?"maxColumn":"minColumn","minRow"===t?"maxRow":"minRow"]}function dt(e,t,[n,o]){const r=t[o],l=e[r];void 0===l&&ue(250,o,String(r));const s=t[n],i=l[s];return void 0===i&&ue(250,n,String(s)),i}function gt(e,t,n,o,r){const l=Le(t,n,o),s=function(e,t){const{minColumn:n,maxColumn:o,minRow:r,maxRow:l}=t;let s=1,i=1,c=1,a=1;const u=e[r],h=e[l];for(let e=n;e<=o;e++)s=Math.max(s,u[e].cell.__rowSpan),a=Math.max(a,h[e].cell.__rowSpan);for(let t=r;t<=l;t++)i=Math.max(i,e[t][n].cell.__colSpan),c=Math.max(c,e[t][o].cell.__colSpan);return{bottomSpan:a,leftSpan:i,rightSpan:c,topSpan:s}}(t,l),{topSpan:i,leftSpan:c,bottomSpan:a,rightSpan:u}=s,h=function(e,t){const n=ut(e,t);return null===n&&ue(249,t.cell.getKey()),n}(l,n),[d,g]=ht(h);let f=l[d],m=l[g];"forward"===r?f+="maxColumn"===d?1:c:"backward"===r?f-="minColumn"===d?1:u:"down"===r?m+="maxRow"===g?1:i:"up"===r&&(m-="minRow"===g?1:a);const p=t[m];if(void 0===p)return!1;const C=p[f];if(void 0===C)return!1;const[S,_]=function(e,t,n){const o=Le(e,t,n),r=ut(o,t);if(r)return[dt(e,o,r),dt(e,o,ht(r))];const l=ut(o,n);if(l)return[dt(e,o,ht(l)),dt(e,o,l)];const s=["minColumn","minRow"];return[dt(e,o,s),dt(e,o,ht(s))]}(t,n,C),w=xt(e,S.cell),b=xt(e,_.cell);return e.$setAnchorCellForSelection(w),e.$setFocusCellForSelection(b,!0),!0}function ft(e,t){if(m(e)||ze(e)){const n=t.isParentOf(e.anchor.getNode()),o=t.isParentOf(e.focus.getNode());return n&&o}return!1}function mt(e,t){t?e.selectStart():e.selectEnd()}function pt(t,n){const o=n.elem,r=t._config.theme;ie(B(o))||ue(131),e(o,r.tableCellSelected)}function Ct(e,t){const o=t.elem;ie(B(o))||ue(131);const r=e._config.theme;n(o,r.tableCellSelected)}function St(e){const n=t(e,ie);return ie(n)?n:null}function _t(e){const n=t(e,$t);return $t(n)?n:null}function wt(e,n,o,r,l){if(("up"===o||"down"===o)&&function(e){const t=e.getRootElement();if(!t)return!1;return t.hasAttribute("aria-controls")&&"typeahead-menu"===t.getAttribute("aria-controls")}(e))return!1;const s=f();if(!ft(s,r)){if(m(s)){if("backward"===o){if(s.focus.offset>0)return!1;const e=function(e){for(let t=e,n=e;null!==n;t=n,n=n.getParent())if(c(n)){if(n!==t&&n.getFirstChild()!==t)return null;if(!n.isInline())return n}return null}(s.focus.getNode());if(!e)return!1;const t=e.getPreviousSibling();return!!$t(t)&&(bt(n),n.shiftKey?s.focus.set(t.getParentOrThrow().getKey(),t.getIndexWithinParent(),"element"):t.selectEnd(),!0)}if(n.shiftKey&&("up"===o||"down"===o)){const e=s.focus.getNode();if(!s.isCollapsed()&&("up"===o&&!s.isBackward()||"down"===o&&s.isBackward())){let l=t(e,(e=>$t(e)));if(ie(l)&&(l=t(l,$t)),l!==r)return!1;if(!l)return!1;const i="down"===o?l.getNextSibling():l.getPreviousSibling();if(!i)return!1;let a=0;"up"===o&&c(i)&&(a=i.getChildrenSize());let h=i;if("up"===o&&c(i)){const e=i.getLastChild();h=e||i,a=u(h)?h.getTextContentSize():0}const d=s.clone();return d.focus.set(h.getKey(),a,u(h)?"text":"element"),N(d),bt(n),!0}if(I(e)){const e="up"===o?s.getNodes()[s.getNodes().length-1]:s.getNodes()[0];if(e){if(null!==Qe(r,e)){const e=r.getFirstDescendant(),t=r.getLastDescendant();if(!e||!t)return!1;const[n]=Be(e),[o]=Be(t),s=r.getCordsFromCellNode(n,l.table),i=r.getCordsFromCellNode(o,l.table),c=r.getDOMCellFromCordsOrThrow(s.x,s.y,l.table),a=r.getDOMCellFromCordsOrThrow(i.x,i.y,l.table);return l.$setAnchorCellForSelection(c),l.$setFocusCellForSelection(a,!0),!0}}return!1}{let r=t(e,(e=>c(e)&&!e.isInline()));if(ie(r)&&(r=t(r,$t)),!r)return!1;const i="down"===o?r.getNextSibling():r.getPreviousSibling();if($t(i)&&l.tableNodeKey===i.getKey()){const e=i.getFirstDescendant(),t=i.getLastDescendant();if(!e||!t)return!1;const[r]=Be(e),[l]=Be(t),c=s.clone();return c.focus.set(("up"===o?r:l).getKey(),"up"===o?0:l.getChildrenSize(),"element"),bt(n),N(c),!0}}}}return"down"===o&&Ft(e)&&l.setShouldCheckSelection(),!1}if(m(s)&&s.isCollapsed()){const{anchor:i,focus:a}=s,u=t(i.getNode(),ie),h=t(a.getNode(),ie);if(!ie(u)||!u.is(h))return!1;const d=_t(u);if(d!==r&&null!=d){const t=Ve(d,e.getElementByKey(d.getKey()));if(null!=t)return l.table=lt(d,t),wt(e,n,o,d,l)}if("backward"===o||"forward"===o){const e=i.type,l=i.offset,a=i.getNode();if(!a)return!1;const h=s.getNodes();return(1!==h.length||!U(h[0]))&&(!!function(e,n,o,r){return function(e,t,n){return"element"===e&&("backward"===n?null===t.getPreviousSibling():null===t.getNextSibling())}(e,o,r)||function(e,n,o,r){const l=t(o,(e=>c(e)&&!e.isInline()));if(!l)return!1;const s="backward"===r?0===n:n===o.getTextContentSize();return"text"===e&&s&&("backward"===r?null===l.getPreviousSibling():null===l.getNextSibling())}(e,n,o,r)}(e,l,a,o)&&function(e,n,o,r,l){const[s,i]=He(r,o,o);if(!function(e,t,n){const o=e[0][0],r=e[e.length-1][e[0].length-1],{startColumn:l,startRow:s}=t;return"backward"===n?l===o.startColumn&&s===o.startRow:l===r.startColumn&&s===r.startRow}(s,i,l))return!1;const a=function(e,n,o){const r=t(e,(e=>c(e)&&!e.isInline()));if(!r)return;const l="backward"===n?r.getPreviousSibling():r.getNextSibling();return l&&$t(l)?l:"backward"===n?o.getPreviousSibling():o.getNextSibling()}(n,l,r);if(!a||$t(a))return!1;bt(e),"backward"===l?a.selectEnd():a.selectStart();return!0}(n,a,u,r,o))}const g=e.getElementByKey(u.__key),f=e.getElementByKey(i.key);if(null==f||null==g)return!1;let m;if("element"===i.type)m=f.getBoundingClientRect();else{const t=T(Ge(e));if(null===t||0===t.rangeCount)return!1;m=t.getRangeAt(0).getBoundingClientRect()}const p="up"===o?u.getFirstChild():u.getLastChild();if(null==p)return!1;const C=e.getElementByKey(p.__key);if(null==C)return!1;const S=C.getBoundingClientRect();if("up"===o?S.top>m.top-m.height:m.bottom+m.height>S.bottom){bt(n);const e=r.getCordsFromCellNode(u,l.table);if(!n.shiftKey)return at(l,r,e.x,e.y,o);{const t=r.getDOMCellFromCordsOrThrow(e.x,e.y,l.table);l.$setAnchorCellForSelection(t),l.$setFocusCellForSelection(t,!0)}return!0}}else if(ze(s)){const{anchor:i,focus:c}=s,a=t(i.getNode(),ie),u=t(c.getNode(),ie),[h]=s.getNodes();$t(h)||ue(251);const d=Ve(h,e.getElementByKey(h.getKey()));if(!ie(a)||!ie(u)||!$t(h)||null==d)return!1;l.$updateTableTableSelection(s);const g=lt(h,d),f=r.getCordsFromCellNode(a,g),m=r.getDOMCellFromCordsOrThrow(f.x,f.y,g);if(l.$setAnchorCellForSelection(m),bt(n),n.shiftKey){const[e,t,n]=He(r,a,u);return gt(l,e,t,n,o)}return u.selectEnd(),!0}return!1}function bt(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()}function yt(e,t,n){const o=i();"first"===e?t.insertBefore(o):t.insertAfter(o),o.append(...n||[]),o.selectEnd()}function Nt(e,n,o){const r=o.getParent();if(!r)return;const l=T(Ge(e));if(!l)return;const s=l.anchorNode,i=e.getElementByKey(r.getKey()),c=Ve(o,e.getElementByKey(o.getKey()));if(!s||!i||!c||!i.contains(s)||c.contains(s))return;const a=t(n.anchor.getNode(),(e=>ie(e)));if(!a)return;const u=t(a,(e=>$t(e)));if(!$t(u)||!u.is(o))return;const[h,d]=He(o,a,a),g=h[0][0],f=h[h.length-1][h[0].length-1],{startRow:m,startColumn:p}=d,C=m===g.startRow&&p===g.startColumn,S=m===f.startRow&&p===f.startColumn;return C?"first":S?"last":void 0}function xt(e,t){const{tableNode:n}=e.$lookup(),o=n.getCordsFromCellNode(t,e.table);return n.getDOMCellFromCordsOrThrow(o.x,o.y,e.table)}function Tt(e,t,n){return Qe(e,B(t,n))}function vt(e,t,n,o){const r=e.querySelector("colgroup");if(!r)return;const l=[];for(let e=0;e<n;e++){const t=document.createElement("col"),n=o&&o[e];n&&(t.style.width=`${n}px`),l.push(t)}r.replaceChildren(...l)}function Rt(t,o,r){r?(e(t,o.theme.tableRowStriping),t.setAttribute("data-lexical-row-striping","true")):(n(t,o.theme.tableRowStriping),t.removeAttribute("data-lexical-row-striping"))}const Ot=new WeakSet;function Ft(e=y()){return Ot.has(e)}function kt(e,t){t?Ot.add(e):Ot.delete(e)}class Kt extends l{static getType(){return"table"}getColWidths(){return this.getLatest().__colWidths}setColWidths(e){const t=this.getWritable();return t.__colWidths=e,t}static clone(e){return new Kt(e.__key)}afterCloneFrom(e){super.afterCloneFrom(e),this.__colWidths=e.__colWidths,this.__rowStriping=e.__rowStriping}static importDOM(){return{table:e=>({conversion:Mt,priority:1})}}static importJSON(e){const t=At();return t.__rowStriping=e.rowStriping||!1,t.__colWidths=e.colWidths,t}constructor(e){super(e),this.__rowStriping=!1}exportJSON(){return{...super.exportJSON(),colWidths:this.getColWidths(),rowStriping:this.__rowStriping?this.__rowStriping:void 0,type:"table",version:1}}extractWithChild(e,t,n){return"html"===n}getDOMSlot(e){const t="TABLE"!==e.nodeName&&e.querySelector("table")||e;return"TABLE"!==t.nodeName&&ue(229),super.getDOMSlot(t).withAfter(t.querySelector("colgroup"))}createDOM(t,n){const o=document.createElement("table"),r=document.createElement("colgroup");if(o.appendChild(r),vt(o,0,this.getColumnCount(),this.getColWidths()),Z(r),e(o,t.theme.table),this.__rowStriping&&Rt(o,t,!0),Ft(n)){const n=document.createElement("div"),r=t.theme.tableScrollableWrapper;return r?e(n,r):n.style.cssText="overflow-x: auto;",n.appendChild(o),n}return o}updateDOM(e,t,n){return e.__rowStriping!==this.__rowStriping&&Rt(t,n,this.__rowStriping),vt(t,0,this.getColumnCount(),this.getColWidths()),!1}exportDOM(e){const t=super.exportDOM(e),{element:n}=t;return{after:e=>{if(t.after&&(e=t.after(e)),e&&r(e)&&"TABLE"!==e.nodeName&&(e=e.querySelector("table")),!e||!r(e))return null;const[n]=Pe(this,null,null),o=new Map;for(const e of n)for(const t of e){const e=t.cell.getKey();o.has(e)||o.set(e,{colSpan:t.cell.getColSpan(),startColumn:t.startColumn})}const l=new Set;for(const t of e.querySelectorAll(":scope > tr > [data-temporary-table-cell-lexical-key]")){const e=t.getAttribute("data-temporary-table-cell-lexical-key");if(e){const n=o.get(e);if(t.removeAttribute("data-temporary-table-cell-lexical-key"),n){o.delete(e);for(let e=0;e<n.colSpan;e++)l.add(e+n.startColumn)}}}const s=e.querySelector(":scope > colgroup");if(s){const t=Array.from(e.querySelectorAll(":scope > colgroup > col")).filter(((e,t)=>l.has(t)));s.replaceChildren(...t)}const i=e.querySelectorAll(":scope > tr");if(i.length>0){const t=document.createElement("tbody");for(const e of i)t.appendChild(e);e.append(t)}return e},element:n&&r(n)&&"TABLE"!==n.nodeName?n.querySelector("table"):n}}canBeEmpty(){return!1}isShadowRoot(){return!0}getCordsFromCellNode(e,t){const{rows:n,domRows:o}=t;for(let t=0;t<n;t++){const n=o[t];if(null!=n)for(let o=0;o<n.length;o++){const r=n[o];if(null==r)continue;const{elem:l}=r,s=Tt(this,l);if(null!==s&&e.is(s))return{x:o,y:t}}}throw new Error("Cell not found in table.")}getDOMCellFromCords(e,t,n){const{domRows:o}=n,r=o[t];if(null==r)return null;const l=r[e<r.length?e:r.length-1];return null==l?null:l}getDOMCellFromCordsOrThrow(e,t,n){const o=this.getDOMCellFromCords(e,t,n);if(!o)throw new Error("Cell not found at cords.");return o}getCellNodeFromCords(e,t,n){const o=this.getDOMCellFromCords(e,t,n);if(null==o)return null;const r=B(o.elem);return ie(r)?r:null}getCellNodeFromCordsOrThrow(e,t,n){const o=this.getCellNodeFromCords(e,t,n);if(!o)throw new Error("Node at cords not TableCellNode.");return o}getRowStriping(){return Boolean(this.getLatest().__rowStriping)}setRowStriping(e){this.getWritable().__rowStriping=e}canSelectBefore(){return!0}canIndent(){return!1}getColumnCount(){const e=this.getFirstChild();if(!e)return 0;let t=0;return e.getChildren().forEach((e=>{ie(e)&&(t+=e.getColSpan())})),t}}function Et(e,t){const n=e.getElementByKey(t.getKey());return null===n&&ue(230),lt(t,n)}function Mt(e){const t=At();e.hasAttribute("data-lexical-row-striping")&&t.setRowStriping(!0);const n=e.querySelector(":scope > colgroup");if(n){let e=[];for(const t of n.querySelectorAll(":scope > col")){const n=t.style.width;if(!n||!ne.test(n)){e=void 0;break}e.push(parseFloat(n))}e&&t.setColWidths(e)}return{node:t}}function At(){return h(new Kt)}function $t(e){return e instanceof Kt}export{He as $computeTableMap,Pe as $computeTableMapSkipCellCheck,se as $createTableCellNode,At as $createTableNode,Se as $createTableNodeWithDimensions,pe as $createTableRowNode,Ye as $createTableSelection,Ke as $deleteTableColumn,Me as $deleteTableColumn__EXPERIMENTAL,Ee as $deleteTableRow__EXPERIMENTAL,St as $findCellNode,_t as $findTableNode,Et as $getElementForTableNode,Be as $getNodeTriplet,Xe as $getTableAndElementByKey,_e as $getTableCellNodeFromLexicalNode,De as $getTableCellNodeRect,Ne as $getTableColumnIndexFromTableCellNode,be as $getTableNodeFromLexicalNodeOrThrow,ye as $getTableRowIndexFromTableCellNode,we as $getTableRowNodeFromTableCellNodeOrThrow,Fe as $insertTableColumn,ke as $insertTableColumn__EXPERIMENTAL,ve as $insertTableRow,Oe as $insertTableRow__EXPERIMENTAL,Ft as $isScrollableTablesActive,ie as $isTableCellNode,$t as $isTableNode,Ce as $isTableRowNode,ze as $isTableSelection,Te as $removeTableRowAtIndex,We as $unmergeCell,ce as INSERT_TABLE_COMMAND,oe as TableCellHeaderStates,re as TableCellNode,Kt as TableNode,Je as TableObserver,fe as TableRowNode,nt as applyTableHandlers,rt as getDOMCellFromTarget,Ve as getTableElement,ot as getTableObserverFromTableElement,kt as setScrollableTablesActive};
